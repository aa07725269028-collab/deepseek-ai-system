// ====================================================
// â° EMPIRE SCHEDULER - Ù…Ù†Ø¸Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ
// ğŸ“… ÙŠØ®Ø·Ø· ÙˆÙŠÙ†Ø´Ø± 3-5 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
// ====================================================

const cron = require('node-cron');

class EmpireScheduler {
    constructor() {
        this.schedules = new Map();
        this.timezones = {
            'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©': 'Asia/Riyadh',
            'Ù…ØµØ±': 'Africa/Cairo',
            'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª': 'Asia/Dubai',
            'Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©': 'America/New_York',
            'Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠØ§': 'Europe/London',
            'Ø§Ù„Ù‡Ù†Ø¯': 'Asia/Kolkata',
            'Ø§Ù„ØµÙŠÙ†': 'Asia/Shanghai',
            'Ø±ÙˆØ³ÙŠØ§': 'Europe/Moscow'
        };
        
        this.optimalTimes = {
            'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©': ['18:00', '20:00', '22:00'],
            'Ù…ØµØ±': ['19:00', '21:00', '23:00'],
            'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª': ['17:00', '19:00', '21:00'],
            'Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©': ['19:00', '21:00', '23:00'],
            'Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠØ§': ['18:00', '20:00', '22:00'],
            'Ø§Ù„Ù‡Ù†Ø¯': ['20:00', '22:00', '00:00'],
            'Ø§Ù„ØµÙŠÙ†': ['19:00', '21:00', '23:00'],
            'Ø±ÙˆØ³ÙŠØ§': ['18:00', '20:00', '22:00']
        };
    }
    
    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù†Ø´Ø± Ø°ÙƒÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    createSmartSchedule(user) {
        const { username, country, platforms, contentPreferences } = user;
        
        const timezone = this.timezones[country] || 'Asia/Riyadh';
        const optimalHours = this.optimalTimes[country] || ['18:00', '20:00', '22:00'];
        
        // Ø§Ø®ØªÙŠØ§Ø± 3-5 Ø£ÙˆÙ‚Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ø«Ù„Ù‰
        const selectedTimes = [];
        const numVideos = Math.floor(Math.random() * 3) + 3; // 3-5 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
        
        for (let i = 0; i < numVideos; i++) {
            const randomHour = optimalHours[Math.floor(Math.random() * optimalHours.length)];
            selectedTimes.push(randomHour);
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
        const uniqueTimes = [...new Set(selectedTimes)].sort();
        
        const schedule = {
            username: username,
            country: country,
            timezone: timezone,
            times: uniqueTimes,
            platforms: platforms,
            contentPreferences: contentPreferences || ['education', 'entertainment'],
            videosPerDay: uniqueTimes.length,
            totalWeeklyVideos: uniqueTimes.length * 7,
            status: 'active',
            created_at: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        this.schedules.set(username, schedule);
        
        console.log(`ğŸ“… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø°ÙƒÙŠ Ù„Ù€ ${username}: ${uniqueTimes.length} ÙÙŠØ¯ÙŠÙˆ/ÙŠÙˆÙ…`);
        
        return schedule;
    }
    
    // 2. Ø¬Ø¯ÙˆÙ„Ø© Ù…Ù‡Ø§Ù… Ø§Ù„Ù†Ø´Ø±
    schedulePublication(username, videoData, platform, time) {
        const [hours, minutes] = time.split(':').map(Number);
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ ØªØ¹Ø¨ÙŠØ± cron
        const cronExpression = `${minutes} ${hours} * * *`;
        
        const job = cron.schedule(cronExpression, async () => {
            try {
                console.log(`ğŸš€ Ù†Ø´Ø± Ù…Ù‚Ø±Ø±: ${username} -> ${platform} @ ${time}`);
                
                // Ù‡Ù†Ø§ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù€ Publisher
                const publishResult = {
                    username: username,
                    platform: platform,
                    time: time,
                    video: videoData.id,
                    status: 'published',
                    published_at: new Date().toISOString(),
                    estimated_reach: Math.floor(Math.random() * 10000) + 1000
                };
                
                console.log(`âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø±: ${username} Ø¹Ù„Ù‰ ${platform}`);
                
                return publishResult;
                
            } catch (error) {
                console.error(`âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±: ${username} -> ${platform}:`, error.message);
                
                return {
                    username: username,
                    platform: platform,
                    time: time,
                    status: 'failed',
                    error: error.message,
                    retry_count: 1
                };
            }
        }, {
            scheduled: true,
            timezone: this.schedules.get(username)?.timezone || 'Asia/Riyadh'
        });
        
        return {
            jobId: job.options.name || `job_${Date.now()}`,
            username: username,
            platform: platform,
            time: time,
            cronExpression: cronExpression,
            nextRun: job.nextDate().toISO(),
            status: 'scheduled'
        };
    }
    
    // 3. Ø¬Ø¯ÙˆÙ„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ù†ØµØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    scheduleAllPlatforms(username, videoData, times) {
        const userSchedule = this.schedules.get(username);
        
        if (!userSchedule) {
            console.log(`âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ù€ ${username}`);
            return null;
        }
        
        const jobs = [];
        
        for (const time of times) {
            for (const platform of userSchedule.platforms) {
                const job = this.schedulePublication(username, videoData, platform, time);
                jobs.push(job);
                
                console.log(`ğŸ“Œ Ø¬Ø¯ÙˆÙ„Ø©: ${username} -> ${platform} @ ${time}`);
            }
        }
        
        return {
            username: username,
            totalJobs: jobs.length,
            platforms: userSchedule.platforms,
            times: times,
            jobs: jobs,
            weeklySchedule: this.generateWeeklySchedule(username, jobs)
        };
    }
    
    // 4. Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø£Ø³Ø¨ÙˆØ¹ÙŠ
    generateWeeklySchedule(username, jobs) {
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
        const weeklySchedule = {};
        
        days.forEach(day => {
            weeklySchedule[day] = jobs.map(job => ({
                platform: job.platform,
                time: job.time,
                type: 'video_publication'
            }));
        });
        
        return weeklySchedule;
    }
    
    // 5. Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø¯Ø§ÙˆÙ„ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    async scheduleMultipleUsers(usersData, videoData) {
        console.log(`ğŸ‘¥ Ø¨Ø¯Ø¡ Ø¬Ø¯ÙˆÙ„Ø© ${usersData.length} Ù…Ø³ØªØ®Ø¯Ù…`);
        
        const allSchedules = [];
        
        for (const user of usersData) {
            console.log(`ğŸ”„ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user.username} (${user.country})`);
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø°ÙƒÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userSchedule = this.createSmartSchedule(user);
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø´Ø±
            const scheduledJobs = this.scheduleAllPlatforms(
                user.username,
                videoData,
                userSchedule.times
            );
            
            if (scheduledJobs) {
                allSchedules.push({
                    user: user.username,
                    country: user.country,
                    schedule: userSchedule,
                    jobs: scheduledJobs.jobs,
                    totalPublications: scheduledJobs.totalJobs * 7 // Ø£Ø³Ø¨ÙˆØ¹ ÙƒØ§Ù…Ù„
                });
                
                console.log(`âœ… ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© ${scheduledJobs.totalJobs} Ù…Ù‡Ù…Ø© Ù„Ù€ ${user.username}`);
            }
            
            // ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        return {
            total_users: usersData.length,
            total_scheduled_jobs: allSchedules.reduce((sum, s) => sum + (s.jobs?.length || 0), 0),
            total_weekly_publications: allSchedules.reduce((sum, s) => sum + (s.totalPublications || 0), 0),
            schedules: allSchedules,
            report: `ØªÙ… Ø¬Ø¯ÙˆÙ„Ø© ${allSchedules.length} Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ ${allSchedules.reduce((sum, s) => sum + (s.jobs?.length || 0), 0)} Ù…Ù‡Ù…Ø© Ù†Ø´Ø±`
        };
    }
    
    // 6. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    modifySchedule(username, newTimes) {
        const userSchedule = this.schedules.get(username);
        
        if (!userSchedule) {
            return { success: false, error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
        userSchedule.times = [...new Set(newTimes)].sort();
        userSchedule.videosPerDay = userSchedule.times.length;
        userSchedule.updated_at = new Date().toISOString();
        
        this.schedules.set(username, userSchedule);
        
        console.log(`ğŸ”„ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ ${username}: ${userSchedule.times.length} ÙÙŠØ¯ÙŠÙˆ/ÙŠÙˆÙ…`);
        
        return {
            success: true,
            username: username,
            new_times: userSchedule.times,
            videos_per_day: userSchedule.times.length,
            old_times: userSchedule.times
        };
    }
    
    // 7. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
    stopSchedule(username) {
        const userSchedule = this.schedules.get(username);
        
        if (!userSchedule) {
            return { success: false, error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
        }
        
        userSchedule.status = 'stopped';
        userSchedule.stopped_at = new Date().toISOString();
        
        this.schedules.set(username, userSchedule);
        
        console.log(`â¸ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¬Ø¯ÙˆÙ„ ${username}`);
        
        return {
            success: true,
            username: username,
            status: 'stopped',
            stopped_at: userSchedule.stopped_at,
            total_days_active: Math.floor(
                (new Date() - new Date(userSchedule.created_at)) / (1000 * 60 * 60 * 24)
            )
        };
    }
    
    // 8. Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
    resumeSchedule(username) {
        const userSchedule = this.schedules.get(username);
        
        if (!userSchedule) {
            return { success: false, error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
        }
        
        userSchedule.status = 'active';
        userSchedule.resumed_at = new Date().toISOString();
        
        this.schedules.set(username, userSchedule);
        
        console.log(`â–¶ï¸ ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø¬Ø¯ÙˆÙ„ ${username}`);
        
        return {
            success: true,
            username: username,
            status: 'active',
            resumed_at: userSchedule.resumed_at,
            schedule: userSchedule
        };
    }
    
    // 9. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    getSchedulingStats() {
        const totalUsers = this.schedules.size;
        const activeUsers = [...this.schedules.values()].filter(s => s.status === 'active').length;
        const totalVideosPerDay = [...this.schedules.values()]
            .filter(s => s.status === 'active')
            .reduce((sum, s) => sum + s.videosPerDay, 0);
        
        return {
            total_users: totalUsers,
            active_users: activeUsers,
            inactive_users: totalUsers - activeUsers,
            total_daily_videos: totalVideosPerDay,
            total_weekly_videos: totalVideosPerDay * 7,
            total_monthly_videos: totalVideosPerDay * 30,
            schedules: [...this.schedules.entries()].map(([username, schedule]) => ({
                username,
                ...schedule
            }))
        };
    }
    
    // 10. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    cleanupOldSchedules(daysOld = 30) {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - daysOld);
        
        let cleaned = 0;
        
        for (const [username, schedule] of this.schedules.entries()) {
            const scheduleDate = new Date(schedule.created_at);
            
            if (scheduleDate < cutoffDate && schedule.status === 'stopped') {
                this.schedules.delete(username);
                cleaned++;
                console.log(`ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¬Ø¯ÙˆÙ„ ${username} (Ù‚Ø¯ÙŠÙ…)`);
            }
        }
        
        return {
            cleaned_schedules: cleaned,
            remaining_schedules: this.schedules.size,
            cutoff_date: cutoffDate.toISOString()
        };
    }
}

// ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ
module.exports = EmpireScheduler;
